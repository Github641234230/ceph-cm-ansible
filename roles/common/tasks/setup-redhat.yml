---
- name: Including major version specific variables.
  include_vars: "rhel_{{ ansible_distribution_major_version }}.yml"

- name: Including version specific variables.
  include_vars: "rhel_{{ ansible_distribution_version }}.yml"
  tags:
    - vars

- name: Setup local repo files.
  include: redhat/repos.yml
  tags:
    - repos

- name: Register with subscription-manager.
  include: redhat/entitlements.yml
  tags:
    - entitlements

- name: Perform package related tasks for rhel.
  include: redhat/packages.yml
  tags:
    - packages

- name: Create remote.conf
  template:
    src: remote.conf
    dest: /etc/security/limits.d/remote.conf
    group: root
    owner: root
    mode: 0644

- name: Set mode on /etc/fuse.conf
  file:
    path: /etc/fuse.conf
    mode: 0644

- name: Add the teuthology user to group kvm
  user:
    name: "{{ teuthology_user }}"
    group: kvm

- name: Upload rhel version specific sshd_config.
  template:
    src: "ssh/sshd_config_rhel_{{ ansible_distribution_version }}"
    dest: /etc/ssh/sshd_config
    owner: root 
    group: root
    mode: 0755
  notify:
    - restart sshd
  tags:
    - ssh

- name: Upload ssh_config.
  template:
    src: ssh/ssh_config
    dest: /etc/ssh/ssh_config
    owner: root
    group: root
    mode: 0755
  tags:
    - ssh

- name: Upload a dummy nfs export so that the nfs kernel server starts.
  template:
    src: exports
    dest: /etc/exports
    owner: root
    group: root
    mode: 0644
  notify:
    - start nfs-server
  tags:
    - nfs

- name: Configure /etc/sudoers.
  template:
    src: sudoers
    dest: /etc/sudoers
    owner: root
    group: root
    mode: 0440
    validate: visudo -cf %s

- name: Configure /etc/security/limits.conf
  template:
    src: limits.conf
    dest: /etc/security/limits.conf
    group: root
    owner: root
    mode: 0644

- name: Include rhel 7.0 specific tasks.
  include: redhat/rhel_7.0.yml
  when: ansible_distribution_version == "7.0"

- name: Include rhel 6.x specific tasks.
  include: redhat/rhel_6.yml
  when: ansible_distribution_major_version == "6"
